name: terrarun-tests

services:
  certs:
    build:
      context: ./tests/e2e
      dockerfile: Dockerfile.certs
    working_dir: /tmp
    volumes:
      - certs:/certs

  traefik:
    image: !reset null
    build:
      dockerfile: ./tests/e2e/Dockerfile.traefik
    depends_on:
      certs:
        condition: service_completed_successfully
    ports: !reset []
    volumes: !override
      - certs:/ssl:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    expose:
      - 443

  test-runner:
    depends_on:
      certs:
        condition: service_completed_successfully
    build:
      context: ./tests/e2e
      dockerfile: Dockerfile.tests
    entrypoint: ["/bin/sh", "-c"]
    command: tail -f /dev/null
    init: true
    tty: true
    links:
      - "traefik:terrarun"
    volumes:
      - certs:/etc/ssl/certs:ro

  agent:
    volumes:
      - certs:/etc/ssl/certs:ro
    depends_on:
      certs:
        condition: service_completed_successfully


volumes:
  certs:
